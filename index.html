<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Song Selection | Luther House Chapel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #f8f7f5; color: #3a3a3a; overflow-x: hidden; }
        html { scroll-behavior: smooth; }
        h1, h2, h3, h4, h5 { font-family: 'Cinzel', serif; }
        .btn-primary { background-color: #4a6da7; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(74, 109, 167, 0.4); }
        .btn-primary:hover { background-color: #3a5d97; box-shadow: 0 0 20px rgba(74, 109, 167, 0.6); }
        .btn-secondary { background-color: #6b9ac4; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(107, 154, 196, 0.3); }
        .btn-secondary:hover { background-color: #5b8ab4; box-shadow: 0 0 15px rgba(107, 154, 196, 0.5); }
        .song-card { transition: all 0.3s ease; border-left: 4px solid transparent; animation: waterfall 0.5s ease forwards; opacity: 0; }
        .song-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 4px solid #4a6da7; }
        select, input[type="text"], input[type="search"] { border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        select:focus, input[type="text"]:focus, input[type="search"]:focus { border-color: #4a6da7; box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a5c8e4; border-radius: 10px; }
        .playlist-sidebar { background: linear-gradient(180deg, #4a6da7 0%, #6b9ac4 100%); }
        @keyframes waterfall { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        .loading-note { font-size: 80px; color: #4a6da7; animation: pulse-note 1.5s infinite ease-in-out; }
        @keyframes pulse-note { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
    </style>
</head>
<body>
    <!-- Main App UI -->
    <div id="appContainer" class="pb-48"> <!-- Added padding-bottom to make space for debug log -->
        <div id="loadingIndicator" class="fixed top-0 left-0 w-full h-full bg-[#f8f7f5] z-50 flex items-center justify-center">
            <div class="text-center"><i class="fas fa-music loading-note"></i><p class="mt-4 text-lg text-gray-600 font-semibold">Loading Song Library...</p></div>
        </div>
        <div class="min-h-screen relative">
            <div class="flex">
                <aside id="playlistSidebar" class="playlist-sidebar w-72 lg:w-80 fixed lg:sticky lg:top-0 h-screen text-white z-30 custom-scrollbar overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
                    <!-- Sidebar content -->
                </aside>
                <div id="mainPageContainer" class="flex-1 lg:ml-80 transition-all duration-300 ease-in-out">
                    <!-- Header, Song Finder, Roster, etc. -->
                </div> 
            </div> 
        </div> 
        <!-- All modals -->
    </div>

    <!-- DEBUG LOGGING UI -->
    <div id="debugLog" class="fixed bottom-0 left-0 w-full h-48 bg-black text-white text-xs font-mono overflow-y-scroll p-2 z-[9999] border-t-4 border-red-500">
      <div class="flex justify-between items-center">
        <h3 class="font-bold border-b mb-1">On-Screen Debug Log</h3>
        <button onclick="document.getElementById('debugLog').style.display='none'" class="bg-red-500 px-2 py-1 rounded text-xs">Hide</button>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- DEBUG HELPER ---
        function debugLog(message, isError = false) {
            const logContainer = document.getElementById('debugLog');
            if (logContainer) {
                const entry = document.createElement('div');
                const color = isError ? 'text-red-400' : 'text-green-400';
                entry.className = `p-1 border-b border-gray-700 ${color}`;
                entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // --- CONFIG & GLOBAL STATE ---
        const firebaseConfig = { apiKey: "AIzaSyC5cXBoPSfhpnCl32NzL7HyiCkv4zNsBoM", authDomain: "worship-song-finder.firebaseapp.com", projectId: "worship-song-finder", storageBucket: "worship-song-finder.appspot.com", messagingSenderId: "34741956145", appId: "1:34741956145:web:b721c5f2532f9ea3fe2f10" };
        const SONGS_JSON_URL = "https://script.google.com/macros/s/AKfycbwvNq5QDwLAcY4bVvfDZBetIlgkimtQZcQ_Xad0OwKM_ECBpAqHajuqaZFYlzfyfDzM/exec";
        const ROSTER_JSON_URL = "https://script.google.com/macros/s/AKfycbxkvzBbKmFdqjEa1L-fMXzx2Ygh3yw1kgjEQofZ6CYmkfk3DbtkpfSoDof5AGhPgZYl/exec";
        
        // The rest of your global state variables...
        let allSongsData = [], allRosterData = [], isAppInitialized = false;

        // --- BOOTSTRAPPING ---
        document.addEventListener("DOMContentLoaded", () => {
            debugLog("DOM fully loaded and parsed.");
            main();
        });

        function main() {
            debugLog("main() called.");
            // assignDOMReferences(); // Assuming this is defined elsewhere or not needed for debug
            initializeFirebase();
        }
        
        function initializeFirebase() {
            debugLog("Initializing Firebase...");
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                debugLog("Firebase app initialized successfully.");
                handleAuthentication(auth);
            } catch (err) {
                debugLog(`Firebase initialization FAILED: ${err.toString()}`, true);
            }
        }
        
        function handleAuthentication(auth) {
            debugLog("Setting up auth state listener...");
            onAuthStateChanged(auth, user => {
                if (user) {
                    debugLog(`Auth state changed: User is signed in. UID: ${user.uid}`);
                    if (!isAppInitialized) {
                        startApp();
                    }
                } else {
                    debugLog("Auth state changed: No user. Attempting anonymous sign-in...");
                    signInAnonymously(auth).catch(err => {
                        debugLog(`Anonymous sign-in FAILED: ${err.toString()}`, true);
                        if (!isAppInitialized) {
                           debugLog("Starting app without authenticated user.", true);
                           startApp(); // Still start the app so we can see data loading errors
                        }
                    });
                }
            });
        }
        
        async function startApp() {
            debugLog("startApp() called.");
            if (isAppInitialized) {
                debugLog("startApp() aborted: App already initialized.");
                return;
            };
            isAppInitialized = true;
            
            try {
                debugLog("Fetching song and roster data in parallel...");
                await Promise.all([fetchSongDataWithJSONP(), fetchRosterDataWithJSONP()]);
                debugLog("All data fetching promises resolved.");
            } catch (error) {
                debugLog(`A critical error occurred during data fetching: ${error.toString()}`, true);
            }
            
            // setupEventListeners(); // Assuming defined elsewhere
            // checkUrlForPlaylist(); // Assuming defined elsewhere
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) {
                loadingIndicator.style.opacity = '0';
                setTimeout(() => { loadingIndicator.style.display = 'none'; }, 500);
            }
            debugLog("App startup process finished.");
        }

        function fetchSongDataWithJSONP() {
            debugLog("Attempting to fetch song data...");
            return new Promise((resolve, reject) => {
                const callbackName = 'handleSongData';
                
                window[callbackName] = (data) => {
                    debugLog("Song data callback executed.");
                    document.body.removeChild(script);
                    delete window[callbackName];
                    if (data.error) {
                        debugLog(`Song data script returned an error: ${data.details || data.error}`, true);
                        reject(new Error(data.details || data.error));
                        return;
                    }
                    // processSongData(data);
                    allSongsData = data; // Simplified for debug
                    debugLog(`Successfully processed ${data.length} songs.`);
                    resolve();
                };

                const script = document.createElement('script');
                script.src = `${SONGS_JSON_URL}?callback=${callbackName}`;
                script.onerror = () => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    const errorMsg = 'Network error: Failed to load song data script.';
                    debugLog(errorMsg, true);
                    reject(new Error(errorMsg));
                };

                document.body.appendChild(script);
                debugLog("Song data script tag appended to body.");
            });
        }

        function fetchRosterDataWithJSONP() {
            debugLog("Attempting to fetch roster data...");
            return new Promise((resolve, reject) => {
                const callbackName = 'handleRosterData';

                window[callbackName] = (data) => {
                    debugLog("Roster data callback executed.");
                    document.body.removeChild(script);
                    delete window[callbackName];
                    if (data.error) {
                        debugLog(`Roster data script returned an error: ${data.details || data.error}`, true);
                        reject(new Error(data.details || data.error));
                        return;
                    }
                    // renderRosterGrid(data);
                    allRosterData = data; // Simplified for debug
                    debugLog(`Successfully processed ${data.length} roster month(s).`);
                    resolve();
                };

                const script = document.createElement('script');
                script.src = `${ROSTER_JSON_URL}?callback=${callbackName}`;
                script.onerror = () => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    const errorMsg = 'Network error: Failed to load roster data script.';
                    debugLog(errorMsg, true);
                    reject(new Error(errorMsg));
                };

                document.body.appendChild(script);
                debugLog("Roster data script tag appended to body.");
            });
        }

        // NOTE: The rest of your functions (renderRosterGrid, setupEventListeners, etc.)
        // would go here. I have omitted them for this debugging version to keep it clean.
        // You should paste them back in after the `fetchRosterDataWithJSONP` function.
        // For now, this minimal script is enough to test the loading process.

    </script>
</body>
</html>
