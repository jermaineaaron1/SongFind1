<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Song Selection | Luther House Chapel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #f8f7f5; color: #3a3a3a; overflow-x: hidden; }
        html { scroll-behavior: smooth; }
        h1, h2, h3, h4, h5 { font-family: 'Cinzel', serif; }
        .btn-primary { background-color: #4a6da7; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(74, 109, 167, 0.4); }
        .btn-primary:hover { background-color: #3a5d97; box-shadow: 0 0 20px rgba(74, 109, 167, 0.6); }
        .btn-secondary { background-color: #6b9ac4; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(107, 154, 196, 0.3); }
        .btn-secondary:hover { background-color: #5b8ab4; box-shadow: 0 0 15px rgba(107, 154, 196, 0.5); }
        .song-card { transition: all 0.3s ease; border-left: 4px solid transparent; animation: waterfall 0.5s ease forwards; opacity: 0; }
        .song-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 4px solid #4a6da7; }
        select, input[type="text"], input[type="search"] { border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        select:focus, input[type="text"]:focus, input[type="search"]:focus { border-color: #4a6da7; box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a5c8e4; border-radius: 10px; }
        .playlist-sidebar { background: linear-gradient(180deg, #4a6da7 0%, #6b9ac4 100%); }
        @keyframes waterfall { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        .loading-note { font-size: 80px; color: #4a6da7; animation: pulse-note 1.5s infinite ease-in-out; }
        @keyframes pulse-note { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
    </style>
</head>
<body>
    <div id="loadingIndicator" class="fixed top-0 left-0 w-full h-full bg-[#f8f7f5] z-50 flex items-center justify-center">
        <div class="text-center"><i class="fas fa-music loading-note"></i><p class="mt-4 text-lg text-gray-600 font-semibold">Loading Song Library...</p></div>
    </div>
    <div class="min-h-screen relative">
        <div class="flex">
            <aside id="playlistSidebar" class="playlist-sidebar w-72 lg:w-80 fixed lg:sticky lg:top-0 h-screen text-white z-30 custom-scrollbar overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"></aside>
            <div id="mainPageContainer" class="flex-1 lg:ml-80 transition-all duration-300 ease-in-out"> 
                <header id="mainHeader" class="bg-white shadow-sm sticky top-0 z-20"></header>
                <div id="songFinderView"></div>
                <div id="worshipRosterView" class="hidden container mx-auto px-0 sm:px-6 py-8"></div>
                </div> 
        </div> 
    </div> 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- CONFIG & GLOBAL STATE ---
        const firebaseConfig = { apiKey: "AIzaSyC5cXBoPSfhpnCl32NzL7HyiCkv4zNsBoM", authDomain: "worship-song-finder.firebaseapp.com", projectId: "worship-song-finder", storageBucket: "worship-song-finder.appspot.com", messagingSenderId: "34741956145", appId: "1:34741956145:web:b721c5f2532f9ea3fe2f10" };
        const SONGS_JSON_URL = "https://script.google.com/macros/s/AKfycbwvNq5QDwLAcY4bVvfDZBetIlgkimtQZcQ_Xad0OwKM_ECBpAqHajuqaZFYlzfyfDzM/exec";
        const ROSTER_JSON_URL = "https://script.google.com/macros/s/AKfycbwvNq5QDwLAcY4bVvfDZBetIlgkimtQZcQ_Xad0OwKM_ECBpAqHajuqaZFYlzfyfDzM/exec";
        
        let allSongsData = [], allRosterData = [], isAppInitialized = false;
        // Other global state variables...

        // --- BOOTSTRAPPING ---
        document.addEventListener("DOMContentLoaded", main);

        function main() {
            // assignDOMReferences(); // Assuming this is defined elsewhere
            initializeFirebase();
        }
        
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                // const db = getFirestore(app); // assuming you use db
                handleAuthentication(auth);
            } catch (err) {
                console.error(`Firebase initialization FAILED: ${err}`);
            }
        }
        
        function handleAuthentication(auth) {
            onAuthStateChanged(auth, user => {
                if (user) {
                    if (!isAppInitialized) startApp();
                } else {
                    signInAnonymously(auth).catch(err => {
                        console.error(`Anonymous sign-in FAILED: ${err}`);
                        if (!isAppInitialized) startApp();
                    });
                }
            });
        }
        
        async function startApp() {
            if (isAppInitialized) return;
            isAppInitialized = true;
            
            try {
                await Promise.all([fetchSongDataWithJSONP(), fetchRosterDataWithJSONP()]);
            } catch (error) {
                console.error(`A critical error occurred during data fetching: ${error}`);
            }
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) {
                loadingIndicator.style.opacity = '0';
                setTimeout(() => { loadingIndicator.style.display = 'none'; }, 500);
            }
            // All your other startup functions like setupEventListeners() would go here
        }

        function fetchSongDataWithJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'handleSongData';
                window[callbackName] = (data) => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    if (data.error) {
                        reject(new Error(data.details || data.error));
                        return;
                    }
                    allSongsData = data;
                    resolve();
                };
                const script = document.createElement('script');
                script.src = `${SONGS_JSON_URL}?callback=${callbackName}`;
                script.onerror = () => {
                    document.body.removeChild(script);
                    reject(new Error('Network error: Failed to load song data script.'));
                };
                document.body.appendChild(script);
            });
        }

        function fetchRosterDataWithJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'handleRosterData';
                window[callbackName] = (data) => {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    if (data.error) {
                        reject(new Error(data.details || data.error));
                        return;
                    }
                    allRosterData = data;
                    resolve();
                };
                const script = document.createElement('script');
                script.src = `${ROSTER_JSON_URL}?callback=${callbackName}&action=roster`;
                script.onerror = () => {
                    document.body.removeChild(script);
                    reject(new Error('Network error: Failed to load roster data script.'));
                };
                document.body.appendChild(script);
            });
        }

        // --- PASTE THE REST OF YOUR FUNCTIONS HERE ---
        // (renderRosterGrid, setupEventListeners, etc.)

    </script>
</body>
</html>
