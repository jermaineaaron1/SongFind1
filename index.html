<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worship Song Selection | Luther House Chapel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- (Your existing styles here) -->
</head>
<body>
    <!-- (Your existing HTML structure here) -->

    <!-- Begin updated script -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously
      } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        onSnapshot,
        updateDoc,
        setDoc,
        arrayUnion,
        arrayRemove
      } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC5cXBoPSfhpnCl32NzL7HyiCkv4zNsBoM",
        authDomain: "worship-song-finder.firebaseapp.com",
        projectId: "worship-song-finder",
        storageBucket: "worship-song-finder.appspot.com",
        messagingSenderId: "34741956145",
        appId: "1:34741956145:web:b721c5f2532f9ea3fe2f10"
      };

      // Globals
      let allSongsData = [], allRosterData = [], sitePlaylists = [], songsForNewPlaylist = [];
      let app, auth, db, userId, unsubscribePlaylists = null;
      let isAppInitialized = false;

      document.addEventListener("DOMContentLoaded", async () => {
        initializeApp(firebaseConfig);
        auth = getAuth();
        db   = getFirestore();
        onAuthStateChanged(auth, user => {
          if (user) {
            userId = user.uid;
            startApp();
            loadPlaylistsFromFirestore();
          } else {
            signInAnonymously(auth).catch(console.error);
          }
        });
      });

      async function startApp() {
        if (isAppInitialized) return;
        isAppInitialized = true;
        await Promise.all([fetchSongDataAndInitialize(), fetchRosterData()]);
        setupEventListeners();
        // hide loader
        document.getElementById('loadingIndicator').style.display = 'none';
      }

      // Fetch songs from your Google Apps Script URL
      async function fetchSongDataAndInitialize() {
        try {
          const resp = await fetch(SONGS_JSON_URL);
          const raw  = await resp.json();
          allSongsData = raw.map((s,i) => ({ id:`song-${i}`, ...s }));
          populateAllDropdowns();
        } catch (err) {
          console.error('Song fetch error:', err);
        }
      }

      // NEW: Fetch roster from Firestore
      async function fetchRosterData() {
        try {
          const snap = await getDocs(collection(db, 'roster'));
          allRosterData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (err) {
          console.error('Roster fetch error:', err);
        }
      }

      function loadPlaylistsFromFirestore() {
        if (!userId) return;
        const userDoc = doc(db, 'users', userId);
        unsubscribePlaylists = onSnapshot(userDoc, docSnap => {
          sitePlaylists = docSnap.data().playlists || [];
          renderPlaylistSidebar();
        }, console.error);
      }

      async function updateFirestorePlaylists(newPL) {
        await setDoc(doc(db,'users',userId), { playlists: newPL });
      }

      // (Include your existing functions for UI, search, filter, render, modals, etc.)

    </script>
    <!-- End updated script -->
</body>
</html>
